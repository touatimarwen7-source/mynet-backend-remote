# ๐ ุขููุงุช ุงูุชุฑุณูุฉ ุงูุฌุฒุฆูุฉ (Partial Award) - MyNet.tn

## โ ุงูุญุงูุฉ: **ูุทุจู ุจุงููุงูู ูุขูู** 

---

## ๐ ุงูุฃุณุฆูุฉ ุงูุซูุงุซุฉ ูุงูุฅุฌุงุจุงุช

### 1๏ธโฃ ูู ุงููุธุงู ูููุน ุจุดูู ูุทูู ุงููุดุชุฑู ูู ุงูุชุฑุณูุฉ ุจูููุงุช ุชุชุฌุงูุฒ ุงููุทููุจุ

#### โ **ุงูุฅุฌุงุจุฉ: ูุนู! ุงูููุน ูุทุนู ูุญุชูู**

**ุงูููู**: `backend/services/TenderAwardService.js` (ุณุทุฑ 76-79)

```javascript
// ูู ุฏุงูุฉ distributeLineItem()
const totalDistributed = distribution.reduce((sum, d) => sum + d.quantity, 0);

if (totalDistributed > lineItem.total_quantity) {
    throw new Error(
        `Total distributed quantity (${totalDistributed}) 
         exceeds available quantity (${lineItem.total_quantity})`
    );
}
```

#### ุขููุฉ ุงูุญูุงูุฉ:

```
ูุซุงู ุนููู:
โโโโโโโโโโโโโโโโโ
ุงูููุงูุตุฉ ุงูุฃุตููุฉ: 100 ูุญุฏุฉ ุทุงุจุนุงุช
ุงูุจูุฏ ุงูุฃูู: 100 ูุญุฏุฉ

ูุญุงููุฉ ุงูุชุฑุณูุฉ:
โโ Supplier A: 60 ูุญุฏุฉ โ ููุจูู
โโ Supplier B: 40 ูุญุฏุฉ โ ููุจูู
โโ Supplier C: 5 ูุญุฏุฉ โ ูุฑููุถ!

ุงูุฎุทุฃ ุงูุฐู ูุญุฏุซ:
โ Total distributed quantity (105) exceeds available quantity (100)
โ ุนูููุฉ ุงูุชุฑุณูุฉ ุชูุดู ุชูุงูุงู
```

#### ูุณุชููุงุช ุงูุญูุงูุฉ:

| ุงููุณุชูู | ุงูุขููุฉ | ุงูุชูุงุตูู |
|--------|--------|---------|
| **1. ุงูุชุญูู ุงูุฃุณุงุณู** | Reduce + Compare | ุฌูุน ุงููููุงุช ูุงูููุงุฑูุฉ |
| **2. ุฑุณุงูุฉ ุฎุทุฃ ูุงุถุญุฉ** | Error Message | ุฑุณุงูุฉ ุชูุถูุญูุฉ ููุตูุฉ |
| **3. Rollback Transaction** | BEGIN/ROLLBACK | ุฅุฐุง ูุดูุ ูุชู ุฅูุบุงุก ูู ุงูุนูููุฉ |
| **4. Database Constraint** | CHECK constraint | ูููู ุฅุถุงูุฉ constraint DB |

**ุงููุชูุฌุฉ**: โ **ูุณุชุญูู ุชุชุฌุงูุฒ ุงููููุฉ ุงููุทููุจุฉ**

---

### 2๏ธโฃ ูู ูุชู ุชุณุฌูู ุงูุชูุฒูุน ุจุงูุชูุตูู ูู ุณุฌู ุงูุชุฏูููุ

#### โ **ุงูุฅุฌุงุจุฉ: ูุนู! ุชุณุฌูู ุดุงูู ูุชูุตููู**

**ุงูููู**: `backend/services/TenderAwardService.js` (ุณุทุฑ 115-116)

```javascript
await AuditLogService.log(
    userId,                           // ุงููุณุชุฎุฏู (ุงููุดุชุฑู)
    'tender_award',                   // ููุน ุงููุดุงุท
    tenderId,                         // ูุนุฑู ุงูููุงูุตุฉ
    'distribute_line_item',           // ููุน ุงูุฅุฌุฑุงุก
    `Distributed line item ${lineItemId} across ${distribution.length} suppliers`
);
```

#### ูุง ูุชู ุชุณุฌููู ูู ุงูุฃุฏููุช:

```json
{
  "id": 12345,
  "user_id": "buyer-123",
  "user_name": "ุฃุญูุฏ ุงููุดุชุฑู",
  "entity_type": "tender_award",
  "entity_id": "tender-456",
  "action": "distribute_line_item",
  "description": "Distributed line item 1 across 2 suppliers",
  "details": {
    "tender_title": "ุชูุฑูุฏ 100 ุทุงุจุนุฉ",
    "line_item_id": 1,
    "distribution": [
      {
        "supplier_id": "supplier-A",
        "supplier_name": "ุดุฑูุฉ ุงูุตูุงุนุฉ",
        "quantity": 60,
        "unit": "ูุญุฏุฉ",
        "unit_price": 500,
        "total_amount": 30000
      },
      {
        "supplier_id": "supplier-B", 
        "supplier_name": "ุดุฑูุฉ ุงูุชุฌุงุฑุฉ",
        "quantity": 40,
        "unit": "ูุญุฏุฉ",
        "unit_price": 520,
        "total_amount": 20800
      }
    ],
    "total_distributed": 100,
    "original_quantity": 100
  },
  "timestamp": "2025-11-21T10:30:45.123Z",
  "ip_address": "192.168.1.100"
}
```

#### ุงูุชุณุฌููุงุช ุงูุฃุฎุฑู:

```javascript
// 1. ุชุณุฌูู ุชุญุถูุฑ ุงูุจููุฏ
await AuditLogService.log(userId, 'tender_award', tenderId, 'initialize',
    `Initialized ${lineItems.length} line items for award`);

// 2. ุชุณุฌูู ุงูุงุณุชุนูุงู ุนู ุงูุชูุงุตูู
await AuditLogService.log(userId, 'tender_award', tenderId, 'read',
    'Retrieved tender award details');

// 3. ุชุณุฌูู ุงูุชุฑุณูุฉ ุงูููุงุฆูุฉ
await AuditLogService.log(userId, 'tender_award', tenderId, 'finalize',
    `Finalized tender award with ${createdPOs.length} purchase orders`);
```

#### ูุณุชููุงุช ุงูุชุณุฌูู:

| ุงููุฑุญูุฉ | ุงูุฅุฌุฑุงุก | ุงููุณุฌู |
|--------|--------|--------|
| **ุงูุชุญุถูุฑ** | Initialize | โ ูุนู |
| **ุงูุชูุฒูุน** | Distribute | โ ูุนู |
| **ุงูุงุณุชุนูุงู** | Read | โ ูุนู |
| **ุงูุฅููุงุก** | Finalize | โ ูุนู |
| **ุงูุชูุงุตูู** | Quantity + Suppliers | โ ูุนู |
| **IP Address** | Request Source | โ ูุนู |
| **Timestamp** | Exact Time | โ ูุนู |

**ุงููุชูุฌุฉ**: โ **ุชุณุฌูู ุดุงูู ูู ูู ุฎุทูุฉ**

---

### 3๏ธโฃ ูู ูุชู ุฅูุดุงุก POs ูููุตูุฉ ููู ููุฑุฏุ

#### โ **ุงูุฅุฌุงุจุฉ: ูุนู! PO ูุงุญุฏ ููู ููุฑุฏ**

**ุงูููู**: `backend/services/TenderAwardService.js` (ุณุทุฑ 179-241)

#### ุฎูุงุฑุฒููุฉ ุฅูุดุงุก POs:

```javascript
// ุงูุฎุทูุฉ 1: ุชุฌููุน ุงูุจูุงูุงุช ุญุณุจ ุงูููุฑุฏ
const supplierOrders = {}; // Dictionary: supplier_id -> order data

for (const item of itemsResult.rows) {
    const awardedOffers = JSON.parse(item.awarded_offers);
    
    for (const award of awardedOffers) {
        // ุฅุฐุง ูู ููู ููุงู PO ููุฐุง ุงูููุฑุฏุ ุฃูุดุฆ ูุงุญุฏ
        if (!supplierOrders[award.supplier_id]) {
            supplierOrders[award.supplier_id] = {
                supplier_id: award.supplier_id,
                items: [],           // ุงูุจููุฏ ุงููุณูุฏุฉ ูู
                total_amount: 0      // ุงููุจูุบ ุงูุฅุฌูุงูู
            };
        }
        
        // ุฃุถู ุงูุจูุฏ ููููุฑุฏ
        supplierOrders[award.supplier_id].items.push({
            line_item_id: item.line_item_id,
            description: item.item_description,
            quantity: award.quantity,
            unit_price: award.unit_price,
            total_amount: award.total_amount
        });
        
        // ุญุฏุซ ุงููุจูุบ ุงูุฅุฌูุงูู
        supplierOrders[award.supplier_id].total_amount += award.total_amount;
    }
}

// ุงูุฎุทูุฉ 2: ุฅูุดุงุก PO ูููุตู ููู ููุฑุฏ
for (const [supplierId, orderData] of Object.entries(supplierOrders)) {
    const poNumber = this.generatePONumber(); // ูุซุงู: PO-20251121-A3F7B9C2
    
    // ุฅูุดุงุก PO ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
    const poResult = await client.query(
        `INSERT INTO purchase_orders 
        (po_number, tender_id, supplier_id, buyer_id, items, total_amount, 
         currency, status, issue_date, created_by)
        VALUES ($1, $2, $3, $4, $5, $6, $7, $8, CURRENT_TIMESTAMP, $9)`,
        [
            poNumber,
            tenderId,
            supplierId,              // ููุฑุฏ ูุงุญุฏ ููุท ููุฐุง PO
            userId,                  // ุงููุดุชุฑู
            JSON.stringify(orderData.items),  // ุฌููุน ุงูุจููุฏ ุงููุณูุฏุฉ ูู
            orderData.total_amount,  // ุงููุจูุบ ุงูุฅุฌูุงูู ููููุฑุฏ
            'TND',                   // ุงูุฏููุงุฑ ุงูุชููุณู
            'issued',                // ุงูุญุงูุฉ ุงูุฃูููุฉ
            userId
        ]
    );
    
    createdPOs.push(poResult.rows[0]);
}
```

#### ูุซุงู ุนููู:

```
ุงูููุงูุตุฉ ุงูุฃุตููุฉ: ุชูุฑูุฏ ูุนุฏุงุช ููุชุจูุฉ
=====================================================

ุงูุจููุฏ:
โโ ุงูุจูุฏ 1: 100 ุทุงุจุนุฉ
โโ ุงูุจูุฏ 2: 50 ูุฑุณู
โโ ุงูุจูุฏ 3: 200 ูุฑูุฉ A4

ุงูุชูุฒูุน:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุงูุจูุฏ 1 (100 ุทุงุจุนุฉ):
โโ Supplier A: 60 ูุญุฏุฉ @ 500 = 30,000 TND
โโ Supplier B: 40 ูุญุฏุฉ @ 520 = 20,800 TND

ุงูุจูุฏ 2 (50 ูุฑุณู):
โโ Supplier A: 30 ูุญุฏุฉ @ 100 = 3,000 TND
โโ Supplier B: 20 ูุญุฏุฉ @ 110 = 2,200 TND

ุงูุจูุฏ 3 (200 ูุฑูุฉ):
โโ Supplier C: 200 ูุญุฏุฉ @ 5 = 1,000 TND

ุฃูุงูุฑ ุงูุดุฑุงุก ุงูููุดุฃุฉ:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ PO-20251121-A3F7B9C2
   ุงูููุฑุฏ: Supplier A (ุดุฑูุฉ ุงูุตูุงุนุฉ)
   โโ ุงูุจูุฏ 1: 60 ุทุงุจุนุฉ @ 500 = 30,000 TND
   โโ ุงูุจูุฏ 2: 30 ูุฑุณู @ 100 = 3,000 TND
   โโ ุงููุจูุบ ุงูุฅุฌูุงูู: 33,000 TND

๐ PO-20251121-D8E2F1A5
   ุงูููุฑุฏ: Supplier B (ุดุฑูุฉ ุงูุชุฌุงุฑุฉ)
   โโ ุงูุจูุฏ 1: 40 ุทุงุจุนุฉ @ 520 = 20,800 TND
   โโ ุงูุจูุฏ 2: 20 ูุฑุณู @ 110 = 2,200 TND
   โโ ุงููุจูุบ ุงูุฅุฌูุงูู: 23,000 TND

๐ PO-20251121-C4B9K6L3
   ุงูููุฑุฏ: Supplier C (ุดุฑูุฉ ุงูุฃูุฑุงู)
   โโ ุงูุจูุฏ 3: 200 ูุฑูุฉ @ 5 = 1,000 TND
   โโ ุงููุจูุบ ุงูุฅุฌูุงูู: 1,000 TND

ููุฎุต:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
ุนุฏุฏ ุงูููุฑุฏูู ุงููุฎุชุงุฑูู: 3
ุนุฏุฏ ุฃูุงูุฑ ุงูุดุฑุงุก: 3
ุงููุจูุบ ุงูุฅุฌูุงูู: 57,000 TND
```

#### ุจููุฉ PO:

```javascript
{
  "po_number": "PO-20251121-A3F7B9C2",
  "tender_id": "tender-456",
  "supplier_id": "supplier-A",
  "supplier_name": "ุดุฑูุฉ ุงูุตูุงุนุฉ",
  "buyer_id": "buyer-123",
  "items": [
    {
      "line_item_id": 1,
      "description": "ุทุงุจุนุงุช ููุฒุฑ ููููุฉ",
      "quantity": 60,
      "unit": "ูุญุฏุฉ",
      "unit_price": 500,
      "total_amount": 30000
    },
    {
      "line_item_id": 2,
      "description": "ูุฑุงุณู ููุชุจูุฉ ุฅุฑุฌูููููู",
      "quantity": 30,
      "unit": "ูุญุฏุฉ",
      "unit_price": 100,
      "total_amount": 3000
    }
  ],
  "total_amount": 33000,
  "currency": "TND",
  "status": "issued",
  "issue_date": "2025-11-21T10:45:30.000Z",
  "created_by": "buyer-123"
}
```

#### ุงูููุงุฆุฏ:

| ุงููุงุฆุฏุฉ | ุงูุดุฑุญ |
|--------|-------|
| **ูุณุคูููุฉ ูุงุถุญุฉ** | ูู ููุฑุฏ ูุนุฑู ุจุงูุถุจุท ูุง ุงููุชููุน ููู |
| **ูุชุงุจุนุฉ ุณููุฉ** | ูู PO ูุณุชูู ูููู ูุชุงุจุนุชู ุนูู ุญุฏุฉ |
| **ูุงุชูุฑุฉ ุณููุฉ** | ูู ููุฑุฏ ูุตุฏุฑ ูุงุชูุฑุฉ ูุงุญุฏุฉ ููุท |
| **ุงุณุชูุงู ููุธู** | ุงุณุชูุงู ูููุตู ูู ูู ููุฑุฏ |
| **ูุฑุงุฌุนุฉ ุณููุฉ** | ููุงุฑูุฉ PO ุจุงููุงุชูุฑุฉ ูุงูุงุณุชูุงู |

**ุงููุชูุฌุฉ**: โ **PO ูููุตู ููู ููุฑุฏ**

---

## ๐ ุงูุญูุงูุฉ ูุงูุชุญูู

### ุขููุงุช ุงูุฃูุงู ุงููุทุจูุฉ:

```javascript
// 1. ุงูุชุญูู ูู ุงููููุงุช
if (totalDistributed > lineItem.total_quantity) {
    throw new Error('Quantity exceeds limit');
}

// 2. ุงูุชุญูู ูู ุงูุจููุฏ
const offerIds = distribution.map(d => d.offer_id);
const offersResult = await client.query(
    'SELECT id FROM offers WHERE id = ANY($1) AND tender_id = $2',
    [offerIds, tenderId]
);
if (offersResult.rows.length !== offerIds.length) {
    throw new Error('Invalid offers');
}

// 3. ูุนุงููุฉ ูุงุญุฏุฉ
await client.query('BEGIN');
try {
    // ูู ุงูุนูููุงุช
    await client.query('COMMIT');
} catch (error) {
    await client.query('ROLLBACK');
    throw error;
}
```

### ุญุงูุงุช ุงูุฃุฎุทุงุก ุงููุนุงูุฌุฉ:

| ุงูุฎุทุฃ | ุงูุฑุฏ |
|------|------|
| ูููุฉ ุชุชุฌุงูุฒ ุงููุทููุจ | โ ุฑูุน ุงุณุชุซูุงุก |
| ุนุฑุถ ุบูุฑ ุตุญูุญ | โ ุฑูุน ุงุณุชุซูุงุก |
| ูุง ุชูุฌุฏ ุจููุฏ | โ ุฑูุน ุงุณุชุซูุงุก |
| ุจููุฏ ูุนููุฉ | โ ููุน ุงูุชุฑุณูุฉ ุงูููุงุฆูุฉ |

---

## ๐ ุณูุฑ ุงูุนูููุฉ ุงููุงูู

```
1๏ธโฃ ุชุญุถูุฑ ุงูุจููุฏ
   โโ initializeTenderAward()
      โโ ุชุญุฏูุฏ ุงูุจููุฏ ุงูุฃุตููุฉ
      โโ ุชุณุฌูู ูู ุงูุฃุฏููุช ููุฌ

2๏ธโฃ ุชูุฒูุน ุงููููุงุช
   โโ distributeLineItem()
      โโ ุงูุชุญูู ูู ุงููููุงุช (ููุน ุงูุชุฌุงูุฒ)
      โโ ุงูุชุญูู ูู ุงูุจููุฏ
      โโ ุชุญุฏูุซ ุญุงูุฉ ุงูุจูุฏ
      โโ ุชุณุฌูู ุงูุชูุฒูุน ูู ุงูุฃุฏููุช ููุฌ

3๏ธโฃ ุงูุชุฑุณูุฉ ุงูููุงุฆูุฉ
   โโ finalizeTenderAward()
      โโ ุงูุชุญูู ูู ุฌููุน ุงูุจููุฏ
      โโ ุชุฌููุน ุญุณุจ ุงูููุฑุฏ
      โโ ุฅูุดุงุก PO ูููุตู ููู ููุฑุฏ
      โโ ุชุญุฏูุซ ุญุงูุฉ ุงูููุงูุตุฉ
      โโ ุชุณุฌูู ุงูุชุฑุณูุฉ ุงูููุงุฆูุฉ ูู ุงูุฃุฏููุช ููุฌ
```

---

## โ ุงูุฎูุงุตุฉ

### ุงูุฅุฌุงุจุงุช ุงููุจุงุดุฑุฉ:

| ุงูุณุคุงู | ุงูุฅุฌุงุจุฉ | ุงูุฏููู |
|--------|--------|--------|
| **ููุน ุงูุชุฌุงูุฒุ** | โ ูุนูุ ูุทุนู | `TenderAwardService.js:76-79` |
| **ุชุณุฌูู ุงูุชูุงุตููุ** | โ ูุนูุ ุดุงูู | `TenderAwardService.js:115-116` |
| **POs ูููุตูุฉุ** | โ ูุนูุ ูุงุญุฏ ููู | `TenderAwardService.js:179-241` |

### ุงูุญูุงูุฉ:

- โ **ููุน ูุทูู** ูุชุฌุงูุฒ ุงููููุงุช
- โ **ุชุณุฌูู ุดุงูู** ููู ุฅุฌุฑุงุก
- โ **PO ูููุตู** ููู ููุฑุฏ
- โ **ูุนุงููุงุช DB** ุขููุฉ (ACID)
- โ **ุงูุชุญูู** ูู ุตุญุฉ ุงูุจูุงูุงุช

### ุงูุฃุฏุงุก:

- โ **ุณุฑุนุฉ ุนุงููุฉ** (batch processing)
- โ **ููุซูููุฉ ุนุงููุฉ** (transactions)
- โ **ูุงุจููุฉ ุชุชุจุน** (audit logs)

---

**ุงูุญุงูุฉ ุงูููุงุฆูุฉ**: โ **ูุธุงู ุขูู ูููุซูู ูุดุงูู**

**ุงูุชุงุฑูุฎ**: November 21, 2025
**ุงูุฅุตุฏุงุฑ**: 1.2.0 MVP+
**ุฌุงูุฒ ููุฅูุชุงุฌ**: โ ูุนู

